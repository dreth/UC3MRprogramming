---
title: 'R Final Project: The Titanic'
author: "Daniel Alonso & Ander Iturburu"
date: "October 28th, 2020"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# The Titanic disaster dataset\

## Introduction\
\
In this project we will explore the Titanic Passenger's dataset. We intend to make a surface description of the datasets
through plots, analysis of such plots and detailed descriptions of our observations relating them. We will also use caret to analyze the relationship of one of our categorical variables in terms of other variables (in our case, mortality of the titanic's passengers).\

The project will be divided in two parts: The descriptive analysis and the use of caret to relate the variables. Each part will explore a few key points that we consider quite interesting. We want to create a general idea of the content of the dataset in order to later on effectively know what might have affected the mortality of passengers in the titanic. The teachings from such a tragic event must've taught us something right? \

A few key points to explore will be:

  - How are our most relevant variables distributed?
  - How do these variables respond to grouping by categorical variables in the dataset?
  - Which variables are correlated to which?
  - What is really relevant when it comes to determining a possible increase in risk of death of the passengers?\

Among other things, which hopefully shall paint an accurate full picture when it comes to the risk of death in this tragic event. \

### First off let's load the libraries we'll use during this project

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(fitdistrplus)
library(PerformanceAnalytics)
library(reshape2)
library(vcd)
library(EnvStats)
library(scales)
```
## How does the data look?\

### Importing the data\

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
data = read.csv('data/titanic.csv')
```

### Dataset head\

```{r, echo=TRUE}
head(data)
```

### Ommitting nans on a separate dataset

The purpose of this is to have a dataset with all the content which we will use for predictions, and a dataset with all the data, except nan values. The latter will be used exclusively for plotting and for descriptive analysis.\

```{r, echo=TRUE}
data_n <- na.omit(data)
```

\newpage

## Variables\

#### ID:

- PassengerId: A unique identifying number for every passenger listed in an SQL-like fashion

#### Other identifying variables:

- Name: Name of the passenger
- Ticket: Ticket number/code for the passenger
- Cabin: Cabin the passenger boarded the cruise in

#### Continuous:

- Fare: Amount paid by the passenger to board the cruise
- Age: Age of the passenger during the cruise boarding in years

#### Discrete:

- SibSp: This is the total amount of siblings/step-siblings and spouses that a passenger has
- Sex: the passenger's sex
- Survived: a boolean variable that describes whether the passenger survived or not
- Pclass: a variable that describes the class in which the passenger sailed aboard the cruise ship (1st,2nd,3rd class)
- parch: This is the total amount of parents (mother, father) or children (son, daughter, step-son/daughter) that a given passenger has

\newpage

## Descriptive Analysis\

### Setting default plot sizes\

```{r, echo=TRUE}
options(repr.plot.width = 14, repr.plot.height = 8)
```

### Histogram for Age\

```{r, echo=TRUE}
hist(data$Age)
```

Figure 1\

In Figure 1 we can see the age distribution shows the mean age between 25-35 years old. We can see there is a significantly larger right tail than left tail. With a large amount of young children, all, more than likely related to other passengers (their parents). The plot resembles a normal distribution in its concentration of individuals around the mean.

There are very few old people, which we could speculate could be due to the significantly lower life expectancy of back then (between 51 and 55 years old in 1910-1920 UK), or due to the fact that maybe a trip aboard the ship might have been aimed to families. Either way, there aren’t many people above 70 (<5) and none above 80.

\newpage

### Histogram for Fare\

```{r, echo=TRUE}
hist(data$Fare)
```

Figure 2\

According to Figure 2 on our second continuous variable (Fare), we notice a significantly different 
situation Vs Age. We have a massively long left tail, as a result of some extremely highly priced tickets payed by a few passengers. Which shows a large and seemingly empty space between fares priced around 250-300 GBP and about 500+ GBP, with little to no tickets payed, showing evidence that some of the tickets, while expensive and very rare among all the individuals (250-300) are still far from the maximum Fare payed (500+). We can clearly see the data is extremely right-skewed.

Extremely expensive tickets, while interesting, are also quite rare. We see that almost all the data concentrates around the 0-100 GBP cost. None being actually free, but yes between 0-1 GBP. We could theorize such cheap tickets probably belonged to children, while most normal tickets were above 20 GBP.

For reference, the ticket prices to board the titanic were the following (in 1912 GBP):

- First Class (parlor suite) — £870
- First Class (berth)— £30
- Second Class — £12
- Third Class — £3 to £8

The conversion rate for £1 (in 1912) would be £115 (in 2019), which shows that even the cheapest tickets (while maybe relatively cheap to board a transatlantic cruise) were still relatively expensive by 1912 standards.

\newpage

### Fitting the normal distribution to Age\

```{r, echo=TRUE}
plot(summary(fitdist(data_n$Age,"norm")))
```

Figure 3\

The age variable seems to show relative normality pretty much across the board with the exception of the slightly larger than usual right tail, as we saw in the histogram previously. This right tail can also be seen differring from a normal distribution in the QQ-plot, however, this overall doesn't hurt the relative normality the variable shows.

We can see the mean very very slightly to the right of a gaussian curve and a slightly longer left tail. Given the current size of the sample we could, perhaps, theorize that the set probably comes from a normal distribution.

An interesting thing to think about would be to, with proper statistical analysis, extrapolate the sample data to the population (everyone aboard the titanic) to see if it accurately describes the reality of the whole ship crew plus passengers. It would be out of the scope of this project, but quite interesting to think about.

\newpage

### Fitting a gamma distribution to Fare\

```{r, echo=TRUE}
plot(summary(fitdist(data_n$Fare+1,"gamma")))
```

Figure 4\

First of all, before plotting, we must sum a constant to Fare, we have chosen 1 to keep values relatively close to the original ones. As some fares are too low and by the nature of the gamma distribution these values would explode. 

We can see that the data seems to follow a gamma distribution , with the exception of its incredibly long tail, which to an extent seems to fall above the theoretical quantiles in the QQ-plot, while the PP-plot seems to favour the left tail above the right tail.

We particularly like this variable as it is interesting to play with and seems to say a lot about the passengers aboard the boat and definitely does not seem to exhibit normality as most of the entries concentrate above relatively low prices, which matches very well the proportion of people in each class.

Boarding the ship wasn't exactly cheap, but we know for a fact that luxury tickets were significantly more expensive than third/second class tickets, therefore making the amount of people able to afford such cabins significantly lower.

\newpage

### Boxplot for Age\

```{r, echo=TRUE}
five <- data.frame(x=rep(1,5), five=fivenum(data_n$Age))

ggplot(data=data_n, aes(x=0, y=data_n$Age)) + 
    geom_boxplot() + 
    theme(text = element_text(size=18)) +
    ylab("Age") +
    scale_x_discrete(breaks = NULL) +
    geom_text(data=five, aes(x=0, y=five, label=five),nudge_x =0.5)
```

Figure 5\

In the Figure 5 we see a boxplot for age with the median at 28, the 25th percentile at 20, the 75th percentile at 38, maximum value at 80 and minimum value at 0.42 (referring to a baby of less than 1 year old).

This shows the wide margin of ages within the ship very clearly. There were all sorts of people of all ages, predominantly men, but definitely all ages.

Older people are a bit more scarce for many reasons, but we could easily attribute such disparity to the life expectancy at the time, which we mentioned previously sat at around 51-55 years old in England.

The relative fragile state of old people during these times, the fact that they might have been significantly more frail than nowadays our old family members are could have discouraged them. Or maybe the cruise trip was simply marketed for younger people and families. However, all these are merely hypotheses.

\newpage

### Boxplot for Fare\

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
five <- data.frame(x=rep(1,5), five=fivenum(data_n$Fare))

ggplot(data=data_n, aes(x=0, y=data_n$Fare)) + 
    geom_boxplot() + 
    theme(text = element_text(size=18)) +
    ylab("Fare") +
    scale_x_discrete(breaks = NULL) +
    geom_text(data=five, aes(x=0, y=five, label=five),nudge_x =0.5, size=1.7)
```

Figure 6\

This boxplot for fare shows a really interesting pattern, similar to what the histogram painted. We can see the 25th and 75th percentile at 8.05 and 33.5 respectively, while the values in between represent most of the data and therefore most of the passengers.

All values above 100 are quite scarce, given that even at 100 GBP, the price was already significantly above the 30 GBP base fare for 1st class. These extreme values which peak at a very far maximum of about 512.33 (the maximum fare) represent a very small subset of very wealthy passengers above the ship.

Our minimum value is 0, which might represent children who probably didn't pay a fare, as maybe part of an offer for very very young children, which were, in fact, aboard the ship.

\newpage

### Quantiles for Age\

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE, fig.width=7, fig.height=3.5}
plot(quantile(data_n$Age))
```

Figure 7\

In the following plot we can see the quantiles more clearly for Age.\

### Quantiles for Fare\

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE, fig.width=7, fig.height=3.5}
plot(quantile(data_n$Fare))
```

Figure 8\

In the following plot we can see the quantiles more clearly for Fare\

Both these plots clearly show the extreme nature of maximum values, especially for Fare.

\newpage

### Correlation between Age and Fare\

```{r, echo=TRUE}
log_data_n = data_n %>% mutate(logAge = log(Age), logFare = log(Fare+100))
ggplot(data=log_data_n, aes(x=logFare, y=logAge)) + 
    geom_point() +
    theme(text = element_text(size=18))
```

Figure 9\

We decided to apply a log transformation for our plot in order to maybe try to make a plot that would better resemble one with a higher spearman correlation coefficient than what a pearson correlation coefficient would yield. However, such coefficient is not significantly larger, as the variables are not quite correlated.

The correlation is extremely low and even if we could draw a line to represent the shape both variables combined would take, we would really not show anything particularly relevant.

We decided to calculate the coefficient itself in order to be sure that it was as low as we expected.

```{r, echo=TRUE}
cols <- data_n %>% dplyr::select(Age, Fare)
cor(cols, method="spearman")
```

The result is about 0.135, which is, as expected, extremely low. We can faintly see the shape of somewhat of two typical spearman correlated variables. We can simply conclude that these two variables are not correlated, and thus age couldn't accurately predict fare nor the opposite.

\newpage

### What about older people?\

Maybe if we segregated the age of the passengers before calculating the correlation, we could get a more interesting picture, let's try that out.

### Correlation between Age and Fare for passengers older than 55 years of age\

```{r, echo=TRUE}
log_data_n = data_n %>% 
              filter(Age >= 55) %>%
              mutate(logAge = log(Age), logFare = log(Fare+100))
ggplot(data=log_data_n, aes(x=logFare, y=logAge)) + 
    geom_point() +
    theme(text = element_text(size=18))
```

Figure 10\

```{r, echo=TRUE}
cols <- log_data_n %>% dplyr::select(logAge, logFare)
cor(cols, method="spearman")
```

We stick with our choice of using spearman, but this definitely did not work out for the older passengers.

\newpage

### What about ages between 25th and 75th percentiles?\

### Correlation between Age and Fare for passengers between 20 and 38 years of age\

```{r, echo=TRUE}
log_data_n = data_n %>% 
              filter(Age >= 20 & Age <= 38 ) %>%
              mutate(logAge = log(Age), logFare = log(Fare+100))
ggplot(data=log_data_n, aes(x=logFare, y=logAge)) + 
    geom_point() +
    theme(text = element_text(size=18))
```

Figure 11\

```{r, echo=TRUE}
cols <- log_data_n %>% dplyr::select(logAge, logFare)
cor(cols, method="spearman")
```

A tad bit better but still definitely not a stronger correlation.

\newpage

### What about ages below the 25th percentile?\

### Correlation between Age and Fare for passengers under 20 years of age\

```{r, echo=TRUE}
log_data_n = data_n %>% 
              filter(Age < 20 ) %>%
              mutate(logAge = log(Age), logFare = log(Fare+100))
ggplot(data=log_data_n, aes(x=logFare, y=logAge)) + 
    geom_point() +
    theme(text = element_text(size=18))
```

Figure 12\

```{r, echo=TRUE}
cols <- log_data_n %>% dplyr::select(logAge, logFare)
cor(cols, method="spearman")
```

Interesting!, so this is definitely stronger than our first example. We can say that most young people and kids are probably coming with their parents, therefore likely paying a cheaper ticket.

\newpage

### Performance Analytics plot\

With a performance analytics plot we can see a histogram for each selected variable, a scatter plot with a plotted line through the points and the correlation number. Showing the power of custom R libraries!\

```{r, echo=TRUE,  warning=FALSE, fig.height=3.5}
pa <- data_n %>% dplyr::select(Age, Fare)
chart.Correlation(pa, histogram=TRUE, pch=19, method="spearman")
```

Figure 13

Interesting!, so this is definitely stronger than our first example. We can say that most young people and kids are probably coming with their parents, therefore likely paying a cheaper ticket.

We can try using the dataset with the log transformations to view the scatter plot a bit less... messy\

```{r, echo=TRUE, warning=FALSE, fig.height=3.3}
pa <- log_data_n %>% dplyr::select(logAge, logFare)
chart.Correlation(pa, histogram=TRUE, pch=19, method="spearman")
```

Figure 14

This didn't quite do much to the scatter plot but did give us a better correlation... suspicious.

\newpage

### Proportions of passengers per sex\

```{r, echo=TRUE,  warning=FALSE, message=FALSE, fig.height=3.7}
# proportions for sex
sex <- data.frame(prop.table(table(data_n$Sex)))
colnames(sex)[1] <- "sex"
sex

# plotting bars
options(repr.plot.width = 8, repr.plot.height = 8)
ggplot(sex, aes(x=sex, y=Freq, fill=sex)) +
 geom_bar(position="dodge", stat="identity") +
 geom_label(aes(y=Freq, label = scales::percent(round(Freq,4), accuracy=0.01)), 
             position=position_dodge(width=0.9),
             show.legend=F)+
 theme(text = element_text(size=18))
```

Figure 15\

We can clearly see that the large majority of patients were male, we nearly twice as many males than females. We could hypothesize that this could be due to the fact that the majority of the crew was make, or maybe females were less likely to risk boarding a cruise, maybe males were more able to pay for the ships given that most females certainly earned less than males in 1912, there could be many reasons for this. The reality is we can't know for sure, but the numbers show an interesting trend.

Let's see what else the sex variable can offer us when grouping.

\newpage

### Grouping passengers by sex\

```{r, echo=TRUE,  warning=FALSE, , message=FALSE, fig.height=3.7}
# summarizing fare, age by mean
sex <- data_n %>% group_by(Sex) %>% summarize(Fare = mean(Fare), Age = mean(Age))
sex

# melt
sex <- melt(sex, id.vars=c("Sex"), measure.vars=c("Fare","Age")) %>% mutate(variable = as.character(variable))

# plotting lines for the 3 variables selected
ggplot(sex, aes(y=value, x=variable, fill=Sex)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(text = element_text(size=18))+
  geom_label(aes(y=value, label = round(value,2), accuracy=0.01),
             position=position_dodge(width=0.9),
             show.legend=F)
```

Figure 16

Grouping passengers by sex shows an interesting story.

We can see that females are slightly younger than males, which accurately portrays an interesting reality of our general demography, but specifically the demography of 1912 England, and this is that men used to prefer to marry younger women. This trend seems to remain in the 21st century, but perhaps not as clearly evident as back in the 20th century and before. where this was pretty much the reality in most households.

For some odd reason, females seem to pay significantly more than males to board the ship. And apparently, on average, about twice as much.

\newpage

### Survival rate per sex\

```{r, echo=TRUE,  warning=FALSE, , message=FALSE, fig.height=3.7}
# summarizing survived by mean
sex <- data_n %>% group_by(Sex) %>% summarize(Survived = mean(Survived))

head(sex)

# sex groupby survive
ggplot(sex, aes(y=Survived, x=Sex, fill=Sex)) + 
  geom_bar(position="dodge", stat="identity")+
  geom_label(aes(y=Survived, label = scales::percent(round(Survived,4), accuracy=0.01)), 
             position=position_dodge(width=0.9),
             show.legend=F)+
  theme(text = element_text(size=18))
```

Figure 17\

The survival rate per sex as shown in the barplot of Figure 17, we can notice that 75.48% of females survived while 20.53% of males survived. The larger percentage of females surviving shows the typical idea of "save the women and children" that we hear on films all the time and that we take as an attitude in catastrophic situations, it shows they were the priority and this sample backs that up.

\newpage

### Proportions of passengers per class\

```{r, echo=TRUE,  warning=FALSE, message=FALSE, fig.height=4}
# proportions for pclass
Pclass <- data.frame(prop.table(table(data_n$Pclass)))
colnames(Pclass)[1] <- "Pclass"
Pclass

# plotting bars
ggplot(Pclass, aes(x=Pclass, y=Freq, fill=Pclass)) +
 geom_bar(position="dodge", stat="identity") +
 geom_label(aes(y=Freq, label = scales::percent(round(Freq,4), accuracy=0.01)), 
             position=position_dodge(width=0.9),
             show.legend=F)+
 theme(text = element_text(size=18))
```

Figure 18\

We can clearly see that the large majority of patients were cruising the ship in 3rd class. Passengers cruising in 3rd class make up about half the passengers on the ship, while there's a very similar amount of passengers in 1st and 2nd class. 2nd class seems to have been the least popular class in which to cruise the ship.

Important to note is that in 1st class there were not just passengers for normal 1st class but also for higher "tiers" of first class depending on their position on the boat and other metrics like suite quality.

\newpage

### Grouping passengers per class\

```{r, echo=TRUE,  warning=FALSE, , message=FALSE, fig.height=3.45}
# summarizing fare, age by mean
pclass <- data_n %>% group_by(Pclass) %>% summarize(Fare = mean(Fare), Age = mean(Age))

# melt
pclass <- melt(pclass, id.vars=c("Pclass"), measure.vars=c("Fare","Age")) %>%
  mutate(variable = as.character(variable), Pclass = as.character(Pclass))
head(pclass)

# plotting lines for the 3 variables selected
ggplot(pclass, aes(y=value, x=variable, fill=Pclass)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(text = element_text(size=18))+
  geom_label(aes(y=value, label = round(value,2), accuracy=0.01),
             position=position_dodge(width=0.9),
             show.legend=F)
```

Figure 19

Here in Figure 19 we can see an interesting pattern looking at Fare and Age per passenger class. We see that the average fare for 1st class is about 4 times larger than the average fare for 2nd class and almost 7 times the average fare for a 3rd class ticket.

A similar story happens with age, we see that the mean age per class relates similarly to the Fare. Older people seem to be more willing to pay for more expensive tickets, probably because they have either a higher income or they're able to afford higher priced tickets.

\newpage

### Survival rate per class\

```{r, echo=TRUE,  warning=FALSE, , message=FALSE, fig.height=4}
# summarizing survived by mean
pclass <- data_n %>% group_by(Pclass) %>% summarize(Survived = mean(Survived)) %>% mutate(Pclass = as.character(Pclass))
head(pclass)

# sex groupby survive
ggplot(pclass, aes(y=Survived, x=Pclass, fill=Pclass)) + 
  geom_bar(position="dodge", stat="identity")+
  geom_label(aes(y=Survived, label = scales::percent(round(Survived,4), accuracy=0.01)), 
             position=position_dodge(width=0.9),
             show.legend=F)+
  theme(text = element_text(size=18))
```

Figure 20

In Figure 20 we see the proportion of survivals per class. We notice that 1st class passengers exhibit a nearly 3x higher survival rate than 3rd class passengers. Highlighting that they were of higher priority when it comes to saving their lives. 

There's probably many reasons as to why this is the case. In the instance that a passenger from first class would hold some kind of high position in a large company at the time, or perhaps hold some kind of political position, these people might be prioritized. 

\newpage

### Proportions of passengers per port of embarkation\

```{r, echo=TRUE,  warning=FALSE, message=FALSE, fig.height=3.7}
# proportions for Embarked
df <- data_n %>% filter(Embarked != '')
Embarked <- data.frame(prop.table(table(df$Embarked)))
colnames(Embarked)[1] <- "Embarked"
Embarked

# plotting bars
ggplot(Embarked, aes(x=Embarked, y=Freq, fill=Embarked)) +
 geom_bar(position="dodge", stat="identity") +
 geom_label(aes(y=Freq, label = scales::percent(round(Freq,4), accuracy=0.01)), 
             position=position_dodge(width=0.9),
             show.legend=F)+
 theme(text = element_text(size=18))
```

Figure 21\

In Figure 21 we see the proportion of passengers embarking from each port of embarkation. Each letter stands for a port:

- C = Cherbourg
- Q = Queenstown
- S = Southampton

We can see clearly that the overwhelming majority of passengers embarked the ship through the Southampton port (77.81%), the majority of the rest through the Cherbourg port and only a few through Queenstown port.

\newpage

### Grouping passengers per port of embarkation\

```{r, echo=TRUE,  warning=FALSE, , message=FALSE, fig.height=3.45}
# summarizing fare, age by mean
embarked <- data_n %>% group_by(Embarked) %>% summarize(Fare = mean(Fare), Age = mean(Age)) %>%
 filter(Embarked != '')

# melt
embarked <- melt(embarked, id.vars=c("Embarked"), measure.vars=c("Fare","Age")) %>%
  mutate(variable = as.character(variable))
embarked

# plotting lines for the 3 variables selected
ggplot(embarked, aes(y=value, x=variable, fill=Embarked)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(text = element_text(size=18))+
  geom_label(aes(y=value, label = round(value,2), accuracy=0.01),
             position=position_dodge(width=0.9),
             show.legend=F)
```

Figure 22

In Figure 22 we see that age doesn't quite play a part in which port of embarkation the passenger used to board the ship. We could say that very very slightly older people seem to board through the Cherbourg port given that older people are also willing to pay more expensive fares and Cherbourg is also the port of embarkation where higher paying passengers boarded the ship, but this might be a stretch.

However we can clearly see that passengers boarding through the Cherbourg port tend to pay higher fares. the other ports seem to be pretty even, with the Queenstown port boarding passengers with overall lower cost tickets.

\newpage

### Survival rate per class\

```{r, echo=TRUE,  warning=FALSE, , message=FALSE, fig.height=4}
# summarizing survived by mean
pclass <- data_n %>% group_by(Pclass) %>% summarize(Survived = mean(Survived)) %>% mutate(Pclass = as.character(Pclass))
head(pclass)

# sex groupby survive
ggplot(pclass, aes(y=Survived, x=Pclass, fill=Pclass)) + 
  geom_bar(position="dodge", stat="identity")+
  geom_label(aes(y=Survived, label = scales::percent(round(Survived,4), accuracy=0.01)), 
             position=position_dodge(width=0.9),
             show.legend=F)+
  theme(text = element_text(size=18))
```

Figure 20

In Figure 19 we see the proportion of survivals per class. We notice that 1st class passengers exhibit a nearly 3x higher survival rate than 3rd class passengers. Highlighting that they were of higher priority when it comes to saving their lives. 

There's probably many reasons as to why this is the case. In the instance that a passenger from first class would hold some kind of high position in a large company at the time, or perhaps hold some kind of political position, these people might be prioritized. 


























